<!DOCTYPE html>
<!-- saved from url=(0076)https://iwiki.woa.com/pages/editpage.action?isEmbeded=true&pageId=1120219983 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link type="text/css" rel="stylesheet" href="./batch(9).css" data-wrm-key="editor-content" data-wrm-batch-type="context" media="all">

<style id="mceDefaultStyles" type="text/css">.mce-content-body div.mce-resizehandle {position: absolute;border: 1px solid black;box-sizing: content-box;background: #FFF;width: 7px;height: 7px;z-index: 10000}.mce-content-body .mce-resizehandle:hover {background: #000}.mce-content-body img[data-mce-selected],.mce-content-body hr[data-mce-selected] {outline: 1px solid black;resize: none}.mce-content-body .mce-clonedresizable {position: absolute;outline: 1px dashed black;opacity: .5;filter: alpha(opacity=50);z-index: 10000}.mce-content-body .mce-resize-helper {background: #555;background: rgba(0,0,0,0.75);border-radius: 3px;border: 1px;color: white;display: none;font-family: sans-serif;font-size: 12px;white-space: nowrap;line-height: 14px;margin: 5px 10px;padding: 5px;position: absolute;z-index: 10001}
.mce-visual-caret {position: absolute;background-color: black;background-color: currentcolor;}.mce-visual-caret-hidden {display: none;}*[data-mce-caret] {position: absolute;left: -1000px;right: auto;top: 0;margin: 0;padding: 0;}
.mce-content-body .mce-offscreen-selection {position: absolute;left: -9999999999px;max-width: 1000000px;}.mce-content-body *[contentEditable=false] {cursor: default;}.mce-content-body *[contentEditable=true] {cursor: text;}
</style><!--<base href="https://iwiki.woa.com/">--><base href="."><style type="text/css">td[data-mce-selected],td[data-mce-selected] p,th[data-mce-selected],th[data-mce-selected] p{background-color:#edf5ff!important}</style><style type="text/css">.wiki-content .text-placeholder { display: inline-block; }</style><style></style></head><body id="tinymce" class="mce-content-body aui-theme-default mceContentBody wiki-content fullsize notranslate page-edit" data-id="wysiwygTextarea" contenteditable="true" style="padding-top: 78px;" data-title="云闪付项目部署文档"><p><span class="text-placeholder">双击markdown插件，就可以开始编辑拉，当前模式，无法黏贴图片哦，仅双击进入markdown编辑模式，才支持黏贴图片</span></p><table class="wysiwyg-macro" data-macro-name="cherry" data-macro-id="bff377fb-e91a-4116-b01c-add76357f7d5" data-macro-default-parameter="" data-macro-schema-version="1" data-macro-body-type="PLAIN_TEXT" style="background-image: url(https://iwiki.woa.com/plugins/servlet/confluence/placeholder/macro-heading?definition=e2NoZXJyeX0&amp;locale=zh_CN&amp;version=2); background-repeat: no-repeat" data-mce-selected="1"><tbody><tr><td class="wysiwyg-macro-body"><pre>⚠️部署之前将现网代码进行打包备份，保证可以回退，以免出现代码未知错误影响月结<br>⚠️由于git项目目录结构和现网目录结构不一样，环境变量的路径存在差异，部署时只把git上代码文件覆盖到现网指定目录的指定的同名文件，不能删除现网文件再上传git文件或者直接覆盖整个文件夹<br># 1. 非手机基础数据统计<br>## 1.1 目标机器<br>IP 9.147.253.83 用户 sett<br>## 1.2 目录映射<br>由于git项目目录结构和现网目录结构不一样，做以下映射<br>**代码目录映射**<br>| git目录 | 机器目录 |<br>| ------ | ------ |<br>| day_count/non_mobile/day_income_count/src| /data/home/sett/settlement/day_income_count/src |<br>**拉取文件的脚本映射**<br>| git目录| 机器目录|<br>| ------ | ------ |<br>| day_count/non_mobile/pull_water_file/src | /data/home/sett/settlement/day_income_count/water_data/src |<br>| day_count/non_mobile/pull_water_file/conf |/data/home/sett/settlement/day_income_count/water_data/conf |<br>**配置**<br>| git目录| 机器目录|<br>| ------ | ------ |<br>| day_count/non_mobile/day_income_count/conf | /data/home/sett/settlement/day_income_count/conf |<br>##1.3 部署流程<br>1.拷贝day_count/non_mobile/day_income_count/src下的代码到映射目录<br>2.拷贝拉取文件的脚本到指定的映射目录<br>3.拷贝配置到指定映射目录<br>## 1.4 数据库结果表增加packet_spoa字段<br>所涉及到的结果表增加`packet_spoa`字段<br>`db_income_day.t_chan_pay_data` <br>``` <br>use db_income_day;<br>alter table t_chan_pay_data add column packet_spoa varchar(50) NOT NULL DEFAULT '' COMMENT '打包包月业务代码';<br>```<br>`db_income_day.t_portal_pay_data`<br>``` <br>alter table t_portal_pay_data add column packet_spoa varchar(50) NOT NULL DEFAULT '' COMMENT '打包包月业务代码';<br>```<br>`db_income_day.t_hfpay_pay_data`<br>``` <br>alter table t_hfpay_pay_data add column packet_spoa varchar(50) NOT NULL DEFAULT '' COMMENT '打包包月业务代码';<br>```<br>`db_income_day.t_hfpay_pay_data_packet_back`<br>``` <br>alter table t_hfpay_pay_data_packet_back add column packet_spoa varchar(50) NOT NULL DEFAULT '' COMMENT '打包包月业务代码';<br>```<br>`db_income_day.t_operator_pay_data`<br>``` <br>alter table t_operator_pay_data add column packet_spoa varchar(50) NOT NULL DEFAULT '' COMMENT '打包包月业务代码';<br>```<br>`db_income_day.t_provide_pay_data`<br>``` <br>alter table t_provide_pay_data add column packet_spoa varchar(50) NOT NULL DEFAULT '' COMMENT '打包包月业务代码';<br>```<br>`db_income_day.t_pay_provide_data`<br>``` <br>alter table t_pay_provide_data add column packet_spoa varchar(50) NOT NULL DEFAULT '' COMMENT '打包包月业务代码';<br>```<br># 2. 包月递延<br>## 2.1 目标机器<br>IP 9.147.253.83 用户 sett<br>## 2.2 目录映射<br>**代码目录映射**<br>| git目录 | 机器目录 |<br>| ------ | ------ |<br>| day_count/monthly_defer/src|/data/home/sett/settlement/monthly_defer/src |<br>**拉取文件的脚本映射**<br>| git目录| 机器目录|<br>| ------ | ------ |<br>| day_count/common_lib/pull_hdfs_file.py | /data/home/sett/settlement/monthly_defer/src/pull_hdfs_file.py |<br>**配置**<br>| git目录| 机器目录|<br>| ------ | ------ |<br>| day_count/monthly_defer/conf |/data/home/sett/settlement/monthly_defer/conf |<br><br>## 2.3 部署流程<br>1.部署启动脚本<br>git下day_count/monthly_defer/task下的脚本到现网/data/home/sett/settlement/monthly_defer/src<br>2.拉取文件标本的部署<br>day_count/common_lib/pull_hdfs_file.py拉取文件脚本放到/data/home/sett/settlement/monthly_defer/src下<br>3.代码部署<br>代码放到相应的映射目录<br># 3. 标准账单库<br>## 3.1 目标机器<br>IP 9.147.252.94 用户 sett<br>## 3.2 目录映射<br>这个是包结构的，不需要映射了<br>| git目录 | 机器目录 |<br>| ------ | ------ |<br>| day_count/reconciliation|/data/home/sett/settlement/reconciliation |<br>## 3.3 数据库结果表增加packet字段<br>`db_revenue_day.t_phone_charge_pay_stat`  packet_spoa<br><br>``` <br>alter table db_revenue_day.t_phone_charge_pay_stat add column packet_spoa varchar(50) NOT NULL DEFAULT '' COMMENT '打包包月业务代码';<br>```<br><br>`db_revenue_day.t_prepay_stat_add` 增加source、packet、spoa_id<br><br>``` <br>alter table db_revenue_day.t_prepay_stat_add add column packet_spoa varchar(50) NOT NULL DEFAULT '' COMMENT '打包包月业务代码';<br>alter table db_revenue_day.t_prepay_stat_add add column source varchar(50) NOT NULL DEFAULT '';<br>alter table db_revenue_day.t_prepay_stat_add add column spoa_id varchar(50) NOT NULL DEFAULT '';<br>```<br><br>`db_revenue_day.t_user_pay_stat`   增加packet_spoa<br><br>``` <br>alter table db_revenue_day.t_user_pay_stat add column packet_spoa varchar(50) NOT NULL DEFAULT '' COMMENT '打包包月业务代码';<br>```<br><br>`db_revenue_day.t_mdo_stat_hfpay` 增加packet_spoa<br><br>``` <br>alter table db_revenue_day.t_mdo_stat_hfpay add column packet_spoa varchar(50) NOT NULL DEFAULT '' COMMENT '打包包月业务代码';<br>```</pre></td></tr></tbody></table><p><br></p><p><br></p><div contenteditable="false" data-mce-bogus="true" class="synchrony-container synchrony-exclude" style="user-select: none;"><div contenteditable="false" data-mce-bogus="true"></div></div></body></html>